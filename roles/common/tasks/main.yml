---

- name: Install ntp
  apt: pkg=ntp
  tags: ntp

- name: Configure ntp file
  template: src=ntp.conf.j2 dest=/etc/ntp.conf
  tags: ntp
  notify: restart ntp

- name: Start the ntp service
  service: name=ntp state=started enabled=true
  tags: ntp

- include: roles/common/tasks/users.yml

- name: Install the unix basics
  tags: repos
  apt: pkg=$item state=latest update_cache=yes
  with_items:
    - screen
    - vim
    - traceroute
    - htop
    - bind9
    - supervisor
    - python-software-properties
  tags: supervisor

- name: Disable open bind recursion so we don't get used for DNS amplification attacks
  copy: src=named.conf.options dest=/etc/bind/named.conf.options owner=root group=bind mode=0644
  tags: bind

- name: Setup zone fragments for file assembly
  file: path=/root/zonefragments state=directory
  tags: bind

- name: Create zone base header
  copy: src=zoneheader dest=/root/zonefragments/00header
  tags: bind

- name: Check supervisor status
  command: /usr/bin/supervisorctl status
  register: supervisorstatus
  ignore_errors: True
  tags: supervisor

- name: Install security packages
  apt: pkg=$item state=latest update_cache=yes
  tags: security
  with_items:
    - apparmor
    - apparmor-profiles
    - apparmor-utils
    - ufw
    - unattended-upgrades

- name: Start apparmor
  service: name=apparmor state=started enabled=true
  tags: security

- name: Enable OpenSSH on ufw
  command: /usr/sbin/ufw allow OpenSSH
  tags: security

- name: Enable Bind9 on ufw
  command: /usr/sbin/ufw allow Bind9
  tags: security

- name: Enable ufw
  command: /usr/sbin/ufw --force enable
  tags: security

- name: Update sshd config to use key auth only
  copy: src=roles/common/files/sshd_config dest=/etc/ssh/sshd_config owner=root group=root mode=0644
  notify: restart sshd

- name: Setup unattended security updates
  copy: src=roles/common/files/apt.10periodic dest=/etc/apt/apt.conf.d/10periodic owner=root group=root mode=0644
