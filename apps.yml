---
# This Playbook deploys the applications to the site

- hosts: server
  user: root
  tasks:
  # Groovie sites
  - name: Copy groovie nginx sites file
    template: >
        src=apps/templates/nginx.groovie
        dest=/etc/nginx/sites-available/groovie
        owner=root group=root mode=0644
    notify: restart nginx

  - name: Copy paste nginx sites file
    template: >
        src=apps/templates/nginx.ofcode
        dest=/etc/nginx/sites-available/ofcode
        owner=root group=root mode=0644
    notify: restart nginx

  - name: Link groovie config to active sites
    file: >
        path=/etc/nginx/sites-enabled/groovie
        src=/etc/nginx/sites-available/groovie
        state=link owner=root group=root
    notify: restart nginx

  - name: Link ofcode config to active sites
    file: >
        path=/etc/nginx/sites-enabled/ofcode
        src=/etc/nginx/sites-available/ofcode
        state=link owner=root group=root
    notify: restart nginx

  # Paste ofcode
  - name: Check out paste.ofcode.org into its repo
    tags: paste
    git: >
        repo=git@github.com:bbangert/ofcode.git
        dest=/var/www/ofcode.org

  handlers:
  - include: roles/common/handlers/main.yml
  - include: roles/dbserver/handlers/main.yml
  - include: roles/webserver/handlers/main.yml
